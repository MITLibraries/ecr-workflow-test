### This is the Terraform-generated dev-build.yml workflow for the ecr-workflow-test-dev app repository ###
### If this is a Lambda repo, uncomment the FUNCTION line at the end of the document     ###
### If the container requires any additional pre-build commands, uncomment and edit      ###
### the PREBUILD line at the end of the document.                                        ###
name: Dev Container Build and Deploy
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '.github/**'

permissions:
  id-token: write
  contents: read

jobs:
  prep:
    runs-on: ubuntu-latest
    outputs: 
      cpuarch: ${{ steps.setarch.outputs.cpuarch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set CPU Architecture
        id: setarch
        run: |
          ARCH=$(cat .aws-architecture)
          if [[ "$ARCH" != "linux/arm64" && "$ARCH" != "linux/amd64" ]]; then
            echo "$ARCH is INVALID architecture!"
            exit 1
          fi
          echo "cpuarch=$ARCH" >> $GITHUB_OUTPUT
          echo "### Architecture Selected" >> $GITHUB_STEP_SUMMARY
          echo "\`$ARCH\` was read from \`.aws-architecture\` and passed to the deploy job." >> $GITHUB_STEP_SUMMARY


  deploy:
    needs: prep
    name: Dev Container Deploy
    uses: mitlibraries/.github/.github/workflows/ecr-multi-arch-deploy-dev.yml@multi-arch-deploy
    secrets: inherit
    with:
      AWS_REGION: "us-east-1"
      GHA_ROLE: "ecr-workflow-test-gha-dev"
      ECR: "ecr-workflow-test-dev"
      CPU_ARCH: ${{ needs.prep.outputs.cpuarch }}
      # FUNCTION: ""
      # PREBUILD: 
